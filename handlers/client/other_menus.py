"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –º–µ–Ω—é (–¥–æ—Å—Ç–∞–≤–∫–∞, –∫—É—Ä—Å)
"""
import logging
from aiogram import Router, F
from aiogram.types import Message
from aiogram.fsm.context import FSMContext

from database.session import get_db
from database.repository import UserRepository
from keyboards.client import get_main_menu_keyboard, get_course_platform_keyboard
from utils.states import ClientState

logger = logging.getLogger(__name__)

# –°–æ–∑–¥–∞–µ–º —Ä–æ—É—Ç–µ—Ä
other_menus_router = Router()

# ========== –î–û–°–¢–ê–í–ö–ê –î–û –î–í–ï–†–ï–ô ==========

@other_menus_router.message(F.text.contains("üöö"))
async def door_delivery_menu(message: Message):
    """–ú–µ–Ω—é –¥–æ—Å—Ç–∞–≤–∫–∏ –¥–æ –¥–≤–µ—Ä–µ–π"""
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {message.from_user.id} –≤—ã–±—Ä–∞–ª '–î–æ—Å—Ç–∞–≤–∫–∞ –¥–æ –¥–≤–µ—Ä–µ–π'")
    
    async for session in get_db():
        user_repo = UserRepository(session)
        user = await user_repo.get_user_by_telegram_id(message.from_user.id)
        
        if not user:
            return
        
        texts = {
            "ru": "üöö <b>–î–æ—Å—Ç–∞–≤–∫–∞ –¥–æ –¥–≤–µ—Ä–µ–π</b>\n\n"
                  "üì¶ <b>–£—Å–ª–æ–≤–∏—è:</b>\n"
                  "‚Ä¢ –î–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤, –ø—Ä–∏–±—ã–≤—à–∏—Ö –≤ –¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω\n"
                  "‚Ä¢ –°—Ç–æ–∏–º–æ—Å—Ç—å: –æ—Ç $10 (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∞–¥—Ä–µ—Å–∞)\n"
                  "‚Ä¢ –°—Ä–æ–∫: 1-3 —Ä–∞–±–æ—á–∏—Ö –¥–Ω—è\n\n"
                  "üìù <b>–ö–∞–∫ –∑–∞–∫–∞–∑–∞—Ç—å:</b>\n"
                  "1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–∞—à —Ç–æ–≤–∞—Ä –∏–º–µ–µ—Ç —Å—Ç–∞—Ç—É—Å '–ù–∞ —Å–∫–ª–∞–¥–µ –≤ –¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω–µ'\n"
                  "2. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É '–ú–æ–∏ —Ç—Ä–µ–∫-–∫–æ–¥—ã'\n"
                  "3. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏\n"
                  "4. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –¥–æ—Å—Ç–∞–≤–∫–∏",
            "tj": "üöö <b>–†–∞—Å–æ–Ω–∏–¥–∞–Ω —Ç–æ –¥–∞—Ä</b>\n\n"
                  "üì¶ <b>–®–∞—Ä—Ç“≥–æ:</b>\n"
                  "‚Ä¢ –¢–∞–Ω“≥–æ –±–∞—Ä–æ–∏ –º–∞“≥—Å—É–ª–æ—Ç–µ –¥–∞—Å—Ç—Ä–∞—Å –∞—Å—Ç, –∫–∏ –±–∞ –¢–æ“∑–∏–∫–∏—Å—Ç–æ–Ω –æ–º–∞–¥–∞–∞–Ω–¥\n"
                  "‚Ä¢ –ù–∞—Ä—Ö: –∞–∑ $10 (–±–∞ –≤–æ–±–∞—Å—Ç–∞–≥–∏–∏ –∞–¥—Ä–µ—Å)\n"
                  "‚Ä¢ –ú—É–¥–¥–∞—Ç: 1-3 —Ä”Ø–∑–∏ –∫–æ—Ä”£\n\n"
                  "üìù <b>–ß”£ —Ç–∞–≤—Ä —Ñ–∞—Ä–º–æ–∏—à –¥–æ–¥–∞–Ω:</b>\n"
                  "1. –ë–æ–≤–∞—Ä”£ “≥–æ—Å–∏–ª –∫—É–Ω–µ–¥, –∫–∏ –º–∞“≥—Å—É–ª–æ—Ç–∏ —à—É–º–æ —Å—Ç–∞—Ç—É—Å–∏ '–î–∞—Ä –∞–Ω–±–æ—Ä–∏ –¢–æ“∑–∏–∫–∏—Å—Ç–æ–Ω' –¥–æ—Ä–∞–¥\n"
                  "2. –¢—É–≥–º–∞–∏ '–†–∞–º–∑“≥–æ–∏ —Ç–∞–º–æ—à–æ–±–∏–Ω–∏ –º–∞–Ω'-—Ä–æ –ø–∞—Ö—à –∫—É–Ω–µ–¥\n"
                  "3. –ú–∞“≥—Å—É–ª–æ—Ç—Ä–æ –±–∞—Ä–æ–∏ —Ä–∞—Å–æ–Ω–∏–¥–∞–Ω –∏–Ω—Ç–∏—Ö–æ–± –∫—É–Ω–µ–¥\n"
                  "4. –§–æ—Ä–º–∏ —Ä–∞—Å–æ–Ω–∏–¥–∞–Ω—Ä–æ –ø—É—Ä –∫—É–Ω–µ–¥"
        }
        
        await message.answer(
            texts[user.language],
            reply_markup=get_main_menu_keyboard(user.language),
            parse_mode="HTML"
        )

# ========== –ë–ï–°–ü–õ–ê–¢–ù–´–ô –ö–£–†–° ==========

@other_menus_router.message(F.text.contains("üéì"))
async def course_menu(message: Message, state: FSMContext):
    """–ú–µ–Ω—é –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –∫—É—Ä—Å–∞"""
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {message.from_user.id} –≤—ã–±—Ä–∞–ª '–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫—É—Ä—Å'")
    
    async for session in get_db():
        user_repo = UserRepository(session)
        user = await user_repo.get_user_by_telegram_id(message.from_user.id)
        
        if not user:
            return
        
        texts = {
            "ru": "üéì <b>–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫—É—Ä—Å –ø–æ –ø–æ–∫—É–ø–∫–∞–º –≤ –ö–∏—Ç–∞–µ</b>\n\n"
                  "–í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É, –ø–æ –∫–æ—Ç–æ—Ä–æ–π —Ö–æ—Ç–∏—Ç–µ –æ–±—É—á–∞—Ç—å—Å—è:",
            "tj": "üéì <b>–ö—É—Ä—Å–∏ –±–µ–ø—É–ª –æ–∏–¥ –±–∞ —Ö–∞—Ä–∏–¥ –¥–∞—Ä –ß–∏–Ω</b>\n\n"
                  "–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞–µ—Ä–æ –∏–Ω—Ç–∏—Ö–æ–± –∫—É–Ω–µ–¥, –∫–∏ –º–µ—Ö–æ“≥–µ–¥ —Ç–∞“≥—Å–∏–ª –∫—É–Ω–µ–¥:"
        }
        
        await message.answer(
            texts[user.language],
            reply_markup=get_course_platform_keyboard(user.language),
            parse_mode="HTML"
        )
        await state.set_state(ClientState.course_menu)

@other_menus_router.message(ClientState.course_menu)
async def course_platform_handler(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –¥–ª—è –∫—É—Ä—Å–∞"""
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {message.from_user.id} –≤—ã–±—Ä–∞–ª –ø–ª–∞—Ç—Ñ–æ—Ä–º—É: {message.text}")
    
    async for session in get_db():
        user_repo = UserRepository(session)
        user = await user_repo.get_user_by_telegram_id(message.from_user.id)
        
        if not user:
            return
        
        # –¢–µ–∫—Å—Ç—ã –∫–Ω–æ–ø–æ–∫
        back_ru = "‚¨ÖÔ∏è –ù–∞–∑–∞–¥"
        back_tj = "‚¨ÖÔ∏è –ë–æ–∑–≥–∞—à—Ç"
        
        if message.text in [back_ru, back_tj]:
            await message.answer(
                "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:" if user.language == "ru" else "–ú–µ–Ω—é–∏ –∞—Å–æ—Å”£:",
                reply_markup=get_main_menu_keyboard(user.language)
            )
            await state.set_state(ClientState.main_menu)
            return
        
        # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Ö
        platform_info = {
            "Taobao": {
                "ru": {
                    "title": "üéì <b>–ö—É—Ä—Å –ø–æ Taobao</b>",
                    "description": "–ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –ø–æ–∫—É–ø–∫–∞–º –Ω–∞ Taobao:\n\n"
                                  "üìö <b>–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∫—É—Ä—Å–∞:</b>\n"
                                  "1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞\n"
                                  "2. –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤ –∏ —Ä–∞–±–æ—Ç–∞ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏\n"
                                  "3. –û–±—â–µ–Ω–∏–µ —Å –ø—Ä–æ–¥–∞–≤—Ü–∞–º–∏\n"
                                  "4. –û–ø–ª–∞—Ç–∞ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å\n"
                                  "5. –î–æ—Å—Ç–∞–≤–∫–∞ –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ\n\n"
                                  "üîó <b>–°—Å—ã–ª–∫–∞ –Ω–∞ –∫—É—Ä—Å:</b>\n"
                                  "https://example.com/taobao-course\n\n"
                                  "‚è∞ <b>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</b> 10 —É—Ä–æ–∫–æ–≤, 5 —á–∞—Å–æ–≤ –≤–∏–¥–µ–æ",
                    "button": "Taobao"
                },
                "tj": {
                    "title": "üéì <b>–ö—É—Ä—Å –æ–∏–¥ –±–∞ Taobao</b>",
                    "description": "–î–∞—Å—Ç—É—Ä“≥–æ–∏ –∫–æ–º–∏–ª –æ–∏–¥ –±–∞ —Ö–∞—Ä–∏–¥ –¥–∞—Ä Taobao:\n\n"
                                  "üìö <b>–ú—É–Ω–¥–∞—Ä–∏“∑–∞–∏ –∫—É—Ä—Å:</b>\n"
                                  "1. –ë–∞“õ–∞–π–¥–≥–∏—Ä”£ –≤–∞ —Ç–∞–Ω–∑–∏–º–∏ “≥–∏—Å–æ–±\n"
                                  "2. “∂—É—Å—Ç—É“∑”Ø–∏ –º–∞“≥—Å—É–ª–æ—Ç –≤–∞ –∫–æ—Ä –±–æ —Ñ–∏–ª—å—Ç—Ä“≥–æ\n"
                                  "3. –°—É“≥–±–∞—Ç –±–æ —Ñ—É—Ä”Ø—à–∞–Ω–¥–∞–≥–æ–Ω\n"
                                  "4. –ü–∞—Ä–¥–æ—Ö—Ç –≤–∞ –∞–º–Ω–∏—è—Ç\n"
                                  "5. –†–∞—Å–æ–Ω–∏–¥–∞–Ω –≤–∞ —Ç–∞–º–æ—à–æ–±–∏–Ω\n\n"
                                  "üîó <b>–ò—Å—Ç–∏–Ω–æ–¥ –±–∞ –∫—É—Ä—Å:</b>\n"
                                  "https://example.com/taobao-course\n\n"
                                  "‚è∞ <b>–ú—É–¥–¥–∞—Ç:</b> 10 –¥–∞—Ä—Å, 5 —Å–æ–∞—Ç –≤–∏–¥–µ–æ",
                    "button": "Taobao"
                }
            },
            "Pinduoduo": {
                "ru": {
                    "title": "üéì <b>–ö—É—Ä—Å –ø–æ Pinduoduo</b>",
                    "description": "–û–±—É—á–µ–Ω–∏–µ –ø–æ–∫—É–ø–∫–∞–º –Ω–∞ Pinduoduo:\n\n"
                                  "üìö <b>–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∫—É—Ä—Å–∞:</b>\n"
                                  "1. –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ Pinduoduo\n"
                                  "2. –°–æ–≤–º–µ—Å—Ç–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏\n"
                                  "3. –ê–∫—Ü–∏–∏ –∏ —Å–∫–∏–¥–∫–∏\n"
                                  "4. –ì–∞—Ä–∞–Ω—Ç–∏–∏ –∫–∞—á–µ—Å—Ç–≤–∞\n"
                                  "5. –í–æ–∑–≤—Ä–∞—Ç —Ç–æ–≤–∞—Ä–æ–≤\n\n"
                                  "üîó <b>–°—Å—ã–ª–∫–∞ –Ω–∞ –∫—É—Ä—Å:</b>\n"
                                  "https://example.com/pinduoduo-course\n\n"
                                  "‚è∞ <b>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</b> 8 —É—Ä–æ–∫–æ–≤, 4 —á–∞—Å–∞ –≤–∏–¥–µ–æ",
                    "button": "Pinduoduo"
                },
                "tj": {
                    "title": "üéì <b>–ö—É—Ä—Å –æ–∏–¥ –±–∞ Pinduoduo</b>",
                    "description": "–¢–∞“≥—Å–∏–ª –¥–∞—Ä –±–æ—Ä–∞–∏ —Ö–∞—Ä–∏–¥ –¥–∞—Ä Pinduoduo:\n\n"
                                  "üìö <b>–ú—É–Ω–¥–∞—Ä–∏“∑–∞–∏ –∫—É—Ä—Å:</b>\n"
                                  "1) –•—É—Å—É—Å–∏—è—Ç“≥–æ–∏ Pinduoduo\n"
                                  "2) –•–∞—Ä–∏–¥“≥–æ–∏ –º—É—à—Ç–∞—Ä–∞–∫\n"
                                  "3) –ê–∫—Å–∏—è“≥–æ –≤–∞ —Ç–∞—Ö—Ñ–∏—Ñ“≥–æ\n"
                                  "4) –ö–∞—Ñ–æ–ª–∞—Ç–∏ —Å–∏—Ñ–∞—Ç\n"
                                  "5) –ë–æ–∑–≥–∞—à—Ç–∏ –º–∞“≥—Å—É–ª–æ—Ç\n\n"
                                  "üîó <b>–ò—Å—Ç–∏–Ω–æ–¥ –±–∞ –∫—É—Ä—Å:</b>\n"
                                  "https://example.com/pinduoduo-course\n\n"
                                  "‚è∞ <b>–ú—É–¥–¥–∞—Ç:</b> 8 –¥–∞—Ä—Å, 4 —Å–æ–∞—Ç –≤–∏–¥–µ–æ",
                    "button": "Pinduoduo"
                }
            },
            "Alibaba": {
                "ru": {
                    "title": "üéì <b>–ö—É—Ä—Å –ø–æ Alibaba</b>",
                    "description": "–û–ø—Ç–æ–≤—ã–µ –∑–∞–∫—É–ø–∫–∏ –Ω–∞ Alibaba:\n\n"
                                  "üìö <b>–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∫—É—Ä—Å–∞:</b>\n"
                                  "1. –ü–æ–∏—Å–∫ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤\n"
                                  "2. –ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã –æ —Ü–µ–Ω–µ\n"
                                  "3. –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø–∞—Ä—Ç–∏–∏ (MOQ)\n"
                                  "4. –õ–æ–≥–∏—Å—Ç–∏–∫–∞ –∏ —Ç–∞–º–æ–∂–Ω—è\n"
                                  "5. –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –∞—Å–ø–µ–∫—Ç—ã\n\n"
                                  "üîó <b>–°—Å—ã–ª–∫–∞ –Ω–∞ –∫—É—Ä—Å:</b>\n"
                                  "https://example.com/alibaba-course\n\n"
                                  "‚è∞ <b>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</b> 12 —É—Ä–æ–∫–æ–≤, 6 —á–∞—Å–æ–≤ –≤–∏–¥–µ–æ",
                    "button": "Alibaba"
                },
                "tj": {
                    "title": "üéì <b>–ö—É—Ä—Å –æ–∏–¥ –±–∞ Alibaba</b>",
                    "description": "–•–∞—Ä–∏–¥“≥–æ–∏ —á–∞–Ω–¥–≥–æ–Ω–∞ –¥–∞—Ä Alibaba:\n\n"
                                  "üìö <b>–ú—É–Ω–¥–∞—Ä–∏“∑–∞–∏ –∫—É—Ä—Å:</b>\n"
                                  "1. “∂—É—Å—Ç—É“∑”Ø–∏ —Ç–∞—ä–º–∏–Ω–∫—É–Ω–∞–Ω–¥–∞–≥–æ–Ω–∏ —Å–∞–Ω“∑–∏–¥–∞—à—É–¥–∞\n"
                                  "2. –ú—É–∑–æ–∫–∏—Ä–æ—Ç –æ–∏–¥ –±–∞ –Ω–∞—Ä—Ö\n"
                                  "3. –ü–∞—Ä—á–∞–º“≥–æ–∏ “≥–∞–¥–¥–∏ –∞“õ–∞–ª (MOQ)\n"
                                  "4. –õ–æ–≥–∏—Å—Ç–∏–∫–∞ –≤–∞ –≥—É–º—Ä—É–∫\n"
                                  "5. “∂–∏“≥–∞—Ç“≥–æ–∏ “≥—É“õ—É“õ”£\n\n"
                                  "üîó <b>–ò—Å—Ç–∏–Ω–æ–¥ –±–∞ –∫—É—Ä—Å:</b>\n"
                                  "https://example.com/alibaba-course\n\n"
                                  "‚è∞ <b>–ú—É–¥–¥–∞—Ç:</b> 12 –¥–∞—Ä—Å, 6 —Å–æ–∞—Ç –≤–∏–¥–µ–æ",
                    "button": "Alibaba"
                }
            }
        }
        
        info = platform_info.get(message.text)
        if info:
            text = f"{info[user.language]['title']}\n\n{info[user.language]['description']}"
            await message.answer(
                text,
                reply_markup=get_course_platform_keyboard(user.language),
                parse_mode="HTML"
            )
        else:
            await message.answer(
                "–í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É –∏–∑ —Å–ø–∏—Å–∫–∞:" if user.language == "ru" 
                else "–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞—Ä–æ –∞–∑ —Ä”Ø–π—Ö–∞—Ç –∏–Ω—Ç–∏—Ö–æ–± –∫—É–Ω–µ–¥:",
                reply_markup=get_course_platform_keyboard(user.language)
            )